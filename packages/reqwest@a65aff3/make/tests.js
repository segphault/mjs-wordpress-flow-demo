var exec=require("child_process").exec,fs=require("fs"),Connect=require("connect"),dispatch=require("dispatch"),mime=require("mime"),DelayedStream=require("delayed-stream"),getMime=function(e){return mime.lookup("jsonp"==e?"js":e)},routes={"/":function(e,t){t.write(fs.readFileSync("./tests/tests.html","utf8")),t.end()},"/tests/timeout$":function(e,t){var n=DelayedStream.create(e);setTimeout(function(){t.writeHead(200,{Expires:0,"Cache-Control":"max-age=0, no-cache, no-store"}),e.query.callback&&t.write(e.query.callback+"("),t.write(JSON.stringify({method:e.method,query:e.query,headers:e.headers})),e.query.callback&&t.write(");"),n.pipe(t)},2e3)},"(([\\w\\-\\/\\.]+)\\.(css|js|json|jsonp|html|xml)$)":function(e,t,n,i,r,a){t.writeHead(200,{Expires:0,"Cache-Control":"max-age=0, no-cache, no-store","Content-Type":getMime(a)}),void 0!==e.query.echo?("jsonp"==a&&t.write((e.query.callback||e.query.testCallback||"echoCallback")+"("),t.write(JSON.stringify({method:e.method,query:e.query,headers:e.headers})),"jsonp"==a&&t.write(");")):t.write(fs.readFileSync("./"+r+"."+a)),t.end()}};Connect.createServer(Connect.query(),dispatch(routes)).listen(1234);var otherOriginRoutes={"/get-value":function(e,t){t.writeHead(200,{"Access-Control-Allow-Origin":e.headers.origin,"Content-Type":"text/plain"}),t.end("hello")},"/set-cookie":function(e,t){t.writeHead(200,{"Access-Control-Allow-Origin":e.headers.origin,"Access-Control-Allow-Credentials":"true","Content-Type":"text/plain","Set-Cookie":"cookie=hello"}),t.end("Set a cookie!")},"/get-cookie-value":function(e,t){var n,i={};e.headers.cookie&&e.headers.cookie.split(";").forEach(function(e){var t=e.split("=");i[t[0].trim()]=(t[1]||"").trim()}),n=i.cookie,t.writeHead(200,{"Access-Control-Allow-Origin":e.headers.origin,"Access-Control-Allow-Credentials":"true","Content-Type":"text/plain"}),t.end(n)}};Connect.createServer(Connect.query(),dispatch(otherOriginRoutes)).listen(5678);